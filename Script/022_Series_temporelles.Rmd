---
title: "04_Series_temporelles"
author: "Julia"
date: "2026-01-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Script permettant d'identifier les séries temporelles et les stations que nous allons étudier ensuite

Ce script permet de compter le nombre d'occurence de chaque indince pour chaque série temporelle. afin ensuite de sélectionner les stations dont les séries temporelles remplissent tous les critères fixés.
## Chargement des packages

```{r}
library(tidyverse)
library(sf) #permet de manipuler des données spatiales
library(lubridate)
library(mapview)
```

## Chargement des fonctions

```{r}
source(here::here("R","fun_borner_series.R"))
```

## Définition des paramètres

```{r}
annee_depart <- 2010

annee_fin <- 2025

n_max_manquant <- 2 #nombre maximum d'année d'années manquantes d'affilé

occurence_min_IBD <- 5 #occurence min = 0, occurence max =13

occurence_min_IBMR <- 5 #occurence min = 0, occurence max =13

occurence_min_IPR <- 5 #occurence min = 1, occurence max =16

occurence_min_I2M2 <- 5 #occurence min = 0, occurence max =19
```

## Arrangement des données

### 1. Sélection de l'échantillonnage le plus tardif de l'année pour n'avoir qu'une seule donnée par indice par an et par station.

```{r}
BDD_serie_tempo_clean <- BDD_serie_tempo%>%
  group_by(code_station,annee,code_support)%>%
  filter(date_prelevement==max(date_prelevement)) 
```

### 2. Identification des séries temporelles

On va utiliser la fonction "borner_series" disponible dans notre répertoire pour sélectionner les stations suivies depuis suffisamment longtemps et pour lesquelles on a un nombre de données suffisantes

```{r}
selection_serie_methode2 <- BDD_serie_tempo_clean %>%
  group_by(code_station,annee, code_indice)%>%
  borner_series(var_id_site=code_station, #variable servant à identifier notre site
                var_temp=annee,
                max_nb_obs_manquantes=n_max_manquant) #maximum de valeurs manquantes accepté (défini dans les paramètres)
```
En sortie de cette fonction, nous obtenons un tableau contenant toutes les séries temporelles, leur période et le nombre d'années auquelles a correspond, le nombre d'occurence de chaque indice au cours de la série temporelle.


### 3. Sélection des stations dont les séries temporelles répondent à nos critères

A présent on filtre les stations pour garder celles qui dont les séries temporelles remplissent nos critères.

```{r}
selection_serie_methode2 <-selection_serie_methode2 %>%
  filter(n_IBD>= occurence_min_IBD,
         n_IPR>= occurence_min_IPR,
         n_I2M2>= occurence_min_I2M2,
         n_IBMR>= occurence_min_IBMR)%>% 
  select(-annee_mini)
```

On filtre notre base de données en gardant les stations retenues à l'étape précédente
```{r}
BDD_serie_tempo_clean <- BDD_serie_tempo_clean %>% 
  filter(code_station %in% selection_serie_methode2$code_station)
```

```{r}
BDD_serie_tempo_clean %>% 
  mapview(popup = "libelle_station")
```

```{r}
stations_etudiees <- selection_serie_methode2$code_station
```

