---
title: "00_Recuperation_donnees_hydrobio"
author: "Julia"
date: "2026-01-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Script Permettant de récupérer les données d'hydrobiologie à partir de l'API Hub'Eau

## Chargement des packages

```{r}
library(hubeau) #fournit les fonctions pour appeler l'API
library(dplyr)
library(stringr)
library(ggplot2)
library(tidyverse)
library(sf) #permet de manipuler des données spatiales
library(lubridate)
library(here) #permet d'appeler des fonctions qui se trouvent dans notre répertoire de travail
```

L'API hydrobiologie développée par Hub'Eau donne accès à trois tables provenant de la base de données NAIADES:

-   stations

-   indices

-   taxons

Dans un premier temps, nous allons accéder à la table "stations" pour récupérer les codes des stations échantillonnées pour l'hydrobiologie ainsi que leurs informations

## Récupérer toutes les stations, situées en Normandie, où des prélèvements hydrobiologiques ont eu lieu.

Pour récupérer les données, nous allons utiliser des fonctions définies dans le fichier "fun_get_data_hydrobio.R" qui se trouve dans notre répertoire de travail.

## Chargement des fonctions

```{r}
source(here::here("R","fun_get_data_hydrobio.R"))
```

## Définition des paramètres nécessaires au fonctionnement des fonctions

```{r message=FALSE}
code_departement <- c("14","27","28","76", "61","50") #Départements qui nous intéressent

station_suivie <- st_read("~/Git/Projet_Poisson_Hydrobio/Data/Stations_peche.gpkg") %>% #lecture du geopackage contenant la liste des stations que l'on étudie
  filter(Etat== "actif") #sélection des stations actives

code_indice <- c(`I2M2` = 7613, `IBMR` = 2928, `IBD` = 5856) # I2M2 (7613), IBMR (2928), IBD (5856)

code_eqb <- c(`Diatomées` = 10, `Macroinvertébrés` = 13, `Macrophytes` = 27)#Un vecteur nommé de codes des éléments de qualité biologique.

code_support <- c("10", "13","27")

annee_depart <- 2010
```
## 1. Télécharger les stations hydrobiologiques correspondant aux stations suivies

```{r}
stations <- telecharger_stations(code_departement, station_suivie)
```

## 2. Télécharger les indices

A présent, nous allons accéder à la table "indices" pour récupérer les indices disponibles pour chaque stations. On utilise les même paramètres définis précédemment.
Les données sont caractérisées par un niveau de conformité. Ici nous choisissons de travailler seulement sur les données qualifiées de "correctes", ce qui correspond au code qualification "1".

```{r}
indices <- telecharger_indices(code_departement, station_suivie, code_indice, annee_depart)%>%
  group_by(libelle_indice, annee, code_qualification)%>%
  filter(code_qualification=="1")
```

### Représenter la disponibilité des données par années pour chaque indice

```{r}
indices_142728 <- indices%>%
  filter(code_departement %in% c("14","27","28"))
```

```{r}
# Dictionnaire de correspondance pour ce graphique
labels_map <- c(
  "Indice Biologique Macrophytique en Rivière (I.B.M.R.)" = "IBMR",
  "Indice Invertébrés Multimétrique (I2M2)" = "I2M2",
  "Indice Biologique Diatomées (IBD)" = "IBD"
)
```

```{r}
graph_indices_142728 <- ggplot(data=indices_142728, aes(x = annee, y=as.character(libelle_station_hydrobio), fill=libelle_indice )) +
  facet_wrap(vars(libelle_indice), labeller = labeller(libelle_indice = labels_map)) +
  geom_tile() +
  labs(title = "Disponibilité des indices par années et par station (Départements 14, 27 et 28)",
       x ="Années",
       y = "") + 
  theme(plot.title = element_text(size=10),
        plot.subtitle = element_text(size=8),
        axis.title.x=element_text(size=8),
        axis.text.x=element_text(size=8),
        axis.text.y = element_text(size=6),
        strip.text = element_text(size = 5),
        legend.title=element_text(size=5),
        legend.text=element_text(size = 5),
        legend.position = "none")+
  guides(fill=guide_legend(nrow=1)) 

graph_indices_142728
```

```{r}
indices_5061761 <- indices%>%
  filter(code_departement %in% c("50","61","76"))
```
```{r}
graph_indices_5061761 <- ggplot(data=indices_5061761, aes(x = annee, y=as.character(libelle_station_hydrobio), fill=libelle_indice )) +
  facet_wrap(vars(libelle_indice), labeller = labeller(libelle_indice = labels_map)) +
  geom_tile() +
  labs(title = "Disponibilité des indices par années et par station (Départements 50, 61 et 76)", 
       x ="Années",
       y = "") + 
  theme(plot.title = element_text(size=9),
        plot.subtitle = element_text(size=7),
        axis.title.x=element_text(size=7),
        axis.text.x=element_text(size=7),
        axis.text.y = element_text(size=6),
        strip.text = element_text(size = 5),
        legend.title=element_text(size=5),
        legend.text=element_text(size = 5),
        legend.position = "none")+
  guides(fill=guide_legend(nrow=1)) 

graph_indices_5061761
```

## 3.1 Télécharger les listes faunistiques et floristiques sans package Hubeau
Le téléchargement prend du temps car il y a énormément de données. Il est important de bien choisir l'année de départ pour limiter le temps de téléchagrment. 

```{r}
liste <- telecharger_listes( code_departement, station_suivie, code_eqb, annee_depart)
#avec ces paramètres on obtient une liste de 199767 observations et 90 variables
```

## 3.2 Télécharger les listes faunistiques et floristiques avec package Hubeau
On doit faire le chargement des données en plusieurs fois car l'API ne permet de télecharger 20 000 données à la fois.
On décide donc de fractionner le téléchargement par années.Il y a environ 14000 lignes par années.
```{r}
mes_stations <-station_suivie$Code.Station.SANDRE
```

```{r}
taxons_av2019 <- get_hydrobio_taxons(code_station_hydrobio=mes_stations, code_support=code_support, code_qualification="1", date_fin_prelevement= "2019-01-01")
```

```{r}
taxons_2019_2020 <- get_hydrobio_taxons(code_station_hydrobio=mes_stations, code_support=code_support, code_qualification="1", date_debut_prelevement= "2019-01-01", date_fin_prelevement="2020-01-01")
```

```{r}
taxons_2020_2021 <- get_hydrobio_taxons(code_station_hydrobio=mes_stations, code_support=code_support, code_qualification="1", date_debut_prelevement= "2020-01-01", date_fin_prelevement="2021-01-01")
```

```{r}
taxons_2021_2022 <- get_hydrobio_taxons(code_station_hydrobio=mes_stations, code_support=code_support, code_qualification="1", date_debut_prelevement= "2021-01-01", date_fin_prelevement="2022-01-01")
```

```{r}
taxons_2022_2023 <- get_hydrobio_taxons(code_station_hydrobio=mes_stations, code_support=code_support, code_qualification="1", date_debut_prelevement= "2022-01-01", date_fin_prelevement="2023-01-01")
```

```{r}
taxons_2023_2024 <- get_hydrobio_taxons(code_station_hydrobio=mes_stations, code_support=code_support, code_qualification="1", date_debut_prelevement= "2023-01-01", date_fin_prelevement="2024-01-01")
```

```{r}
taxons_ap2024 <- get_hydrobio_taxons(code_station_hydrobio=mes_stations, code_support=code_support, code_qualification="1", date_debut_prelevement= "2024-01-01")
```


```{r}
taxons <- bind_rows(taxons_ap2024, taxons_2023_2024, taxons_2022_2023,taxons_2021_2022,taxons_2020_2021,taxons_2019_2020,taxons_av2019)
```

