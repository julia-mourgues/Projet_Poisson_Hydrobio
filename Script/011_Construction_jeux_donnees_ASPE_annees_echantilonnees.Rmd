---
title: "01_Construction_jeux_donnees_ASPE_stations"
author: "Julia"
date: "2026-01-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Script permettant de construire un premier jeu de données destiné à visualiser les années échantillonnées pour chaque station.

## Charger les packages

```{r}
library(aspe)
library(tidyverse) #contient ggplot2 dplyr, tidyr, readr, purrr, tibble, stringr, forcats
library(stringr)
library(sf) #permet de manipuler des données spatiales
```

## Construire le jeu de données

### Charger les données issues de la base Aspe

Les données utilisées ont préalablement été téléchargée à l'aide du script "00_Recuperation_donnees_ASPE".

```{r}
data_aspe <- misc_nom_dernier_fichier(repertoire="~/Git/Projet_Poisson_Hydrobio/Data/raw_data", pattern="^tables") #Permet de sélectionner les données téléchargées le plus récemment
load(data_aspe)
```

### Définition de nos paramètres

Nous allons définir des paramètres qui vont nous permettre de simplifier les codes lors de la construction de notre jeux de données

```{r}
code_departement <- c("14","27","28","76", "61","50") #Départements qui nous intéressent

station_suivie <- st_read("~/Git/Projet_Poisson_Hydrobio/Data/Stations_peche.gpkg") %>% #lecture du geopackage contenant la liste des stations que l'on étudie
  filter(Etat== "actif") #sélection des stations actives

annee_depart <- 2010

annee_fin <- 2025
```

### Mise en correspondance des tables principales

Création d'une "passerelle" qui met en correspondance les identifiants des tables principales de la base

```{r}
passerelle <- aspe::mef_creer_passerelle()
```

Pour alléger les requêtes, on commence par sélectionner les départements correspondant à notre étude. Puis on ajoute les dates des opérations, la qualification des données, le libelle SANDRE des strations ainsi que les réseaux de pêche.

```{r}
aspe_nor <- passerelle %>% 
  mef_ajouter_dept() %>% 
  filter(dept %in% code_departement)%>%#Sélection des 5 départements normands 
  mef_ajouter_ope_date() %>%#on ajoute les dates
  mef_ajouter_qualification()%>% #ajout de la qualification des données (correcte/incorrecte)
  mef_ajouter_libelle_site(origine_libelle="station_sandre")%>% #ajouter le libelle SANDRE des stations
  mef_ajouter_ipr()%>% #Ajouter les valeurs ipr
  mef_ajouter_objectif() %>% 
  mef_ajouter_lots() %>%  #ajouter les lots de poissons
  mef_ajouter_esp() %>% 
  mef_ajouter_type_lot() 
```

On fait une jointure afin d'associer les codes SANDRE au libellé SANDRE de chaque station. Ensuite nous pouvons sélectionner nos stations de travail à l'aide du code SANDRE.

```{r}
aspe_nor<-aspe_nor%>%
  inner_join(station%>%select(sta_id,sta_code_sandre,sta_coordonnees_x,sta_coordonnees_y), by="sta_id")%>%
  inner_join(operation %>% select(ope_id, ope_surface_calculee), by="ope_id") %>% 
  filter(sta_code_sandre %in% station_suivie$Code.Station.SANDRE,
    annee >= annee_depart,
    annee <= annee_fin,
    niq_libelle == "Correcte")%>%
  mutate (sta_libelle_sandre=str_to_sentence(str_to_lower(sta_libelle_sandre)), #Mettre une majuscule au début des libellés puis mettre la suite en minuscules
          densite_m2 = ifelse(is.na(ope_surface_calculee) | ope_surface_calculee <= 0,
                             NA_real_,lop_effectif / ope_surface_calculee)) 


```

## Réorganisation des variables
```{r}
aspe_nor <- aspe_nor %>% 
  select(sta_id, sta_code_sandre, sta_libelle_sandre,pop_id,ope_id,pre_id,lop_id,dept,sta_coordonnees_x, sta_coordonnees_y, ope_surface_calculee, ope_date, annee, ipr, cli_id, cli_libelle,obj_id,obj_libelle,esp_id,esp_code_alternatif, esp_nom_commun, esp_nom_latin, tyl_id, tyl_libelle,tlo_id, lop_effectif, densite_m2, niq_libelle)
```


